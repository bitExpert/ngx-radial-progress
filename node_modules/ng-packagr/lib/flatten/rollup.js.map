{"version":3,"file":"rollup.js","sourceRoot":"","sources":["../../../src/lib/flatten/rollup.ts"],"names":[],"mappings":"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","sourcesContent":["import * as rollup from 'rollup';\nimport * as nodeResolve from 'rollup-plugin-node-resolve';\nimport * as sourcemaps from 'rollup-plugin-sourcemaps';\nimport * as commonJs from 'rollup-plugin-commonjs';\nimport * as rollupJson from 'rollup-plugin-json';\nimport * as path from 'path';\nimport * as log from '../util/log';\nimport { ExternalModuleIdStrategy, DependencyList } from './external-module-id-strategy';\nimport { umdModuleIdStrategy } from './umd-module-id-strategy';\nimport { TransformHook } from 'rollup';\nimport { outputFile, outputJson } from 'fs-extra';\n\n/**\n * Options used in `ng-packagr` for writing flat bundle files.\n *\n * These options are passed through to rollup.\n */\nexport interface RollupOptions {\n  moduleName: string;\n  entry: string;\n  format: rollup.ModuleFormat;\n  dest: string;\n  sourceRoot: string;\n  umdModuleIds?: { [key: string]: string };\n  amd?: { id: string };\n  transform?: TransformHook;\n  dependencyList?: DependencyList;\n}\n\n/** Runs rollup over the given entry file, writes a bundle file. */\nexport async function rollupBundleFile(opts: RollupOptions): Promise<void[]> {\n  log.debug(`rollup (v${rollup.VERSION}) ${opts.entry} to ${opts.dest} (${opts.format})`);\n\n  const externalModuleIdStrategy = new ExternalModuleIdStrategy(opts.format, opts.dependencyList);\n\n  // Create the bundle\n  const bundle = await rollup.rollup({\n    context: 'this',\n    external: moduleId => externalModuleIdStrategy.isExternalDependency(moduleId),\n    inlineDynamicImports: false,\n    input: opts.entry,\n    plugins: [rollupJson(), nodeResolve(), commonJs(), sourcemaps(), { transform: opts.transform }],\n    onwarn: warning => {\n      if (typeof warning === 'string') {\n        log.warn(warning);\n      } else {\n        if (warning.code === 'THIS_IS_UNDEFINED') {\n          return;\n        }\n\n        log.warn(warning.message);\n      }\n    },\n    preserveSymlinks: true\n  });\n\n  // Output the bundle to disk\n  const sourcemapFullFile = `${opts.dest}.map`;\n  const sourcemapFile = path.basename(sourcemapFullFile);\n  const result = await bundle.generate({\n    name: opts.moduleName,\n    format: opts.format,\n    amd: opts.amd,\n    file: opts.dest,\n    banner: '',\n    globals: moduleId => umdModuleIdStrategy(moduleId, opts.umdModuleIds || {}),\n    sourcemap: true,\n    sourcemapFile\n  });\n\n  // relocate sourcemaps\n  result.map.sources = result.map.sources.map(sourcePath => {\n    if (!sourcePath) {\n      return sourcePath;\n    }\n\n    // the replace here is because during the compilation one of the `/` gets lost sometimes\n    const mapRootUrl = opts.sourceRoot.replace('//', '/');\n    if (sourcePath.indexOf(mapRootUrl) > 0) {\n      return `${opts.sourceRoot}${sourcePath.substr(sourcePath.indexOf(mapRootUrl) + mapRootUrl.length)}`;\n    } else if (sourcePath.indexOf(opts.sourceRoot) > 0) {\n      return sourcePath.substr(sourcePath.indexOf(mapRootUrl));\n    } else {\n      return sourcePath;\n    }\n  });\n\n  // rollup doesn't add a sourceMappingURL\n  // https://github.com/rollup/rollup/issues/121\n  result.code = `${result.code}\\n//# sourceMappingURL=${sourcemapFile}`;\n  return Promise.all([outputJson(sourcemapFullFile, result.map), outputFile(opts.dest, result.code)]);\n}\n"]}